---
layout: ../../layouts/BlogLayout.astro
title: æ–°ã—ããªã‚‹CJSã‹ã‚‰ESMã¸ã®èª­ã¿è¾¼ã¿æ–¹æ³•ã®ç´¹ä»‹
date: 2024-03-16
description: Node.jsã§CJSã‹ã‚‰ESMã‚’å‘¼ã³å‡ºã™éš›ã®ä»•çµ„ã¿ãŒä»£ã‚ã‚‹ææ¡ˆãŒå‡ºã¦ãã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ãã®ææ¡ˆã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™
image: /images/brands/nodejs.png
tags: javascript
---

import OG from "../../components/OG.astro";

æ–°ã—ãCJSã¨ESMã®é–“ã§ã®è§£æ±ºæ–¹æ³•ãŒå¤‰ã‚ã‚‹ææ¡ˆãŒå‡ºã¦ãã¾ã—ãŸã€‚
ãƒãƒ¼ã‚¸ã•ã‚Œã¦ã¾ã›ã‚“ãŒã€ã“ã®æ–¹é‡ã‹ã‚‰å¤‰ã‚ã‚‹ã“ã¨ã¯ãªã„ã‚ˆã†ã«è¦‹ãˆã‚‹ã®ã§ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

<OG url="https://github.com/nodejs/node/pull/51977" />

## æ–°ã—ã„ææ¡ˆ

ã“ã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€å°‘ãªãã¨ã‚‚ï¼‘å¹´ã¯ã€`--experimental-require-module`ãƒ•ãƒ©ã‚°ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«package typeã‚’æŒ‡å®šã›ãšã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯CJSã§è¡Œã„ã¾ã™ã€‚

```js
// cjs.js (entry point)

"use strict";

// !!! ä»Šã¾ã§ã“ã‚ŒãŒè¡Œãˆãªã‹ã£ãŸ !!!
const esm = require("./esm.mjs");

console.log(esm);
// [Module: null prototype] {
//   default: 'default',
//   named: [AsyncFunction: named]
// }
```

```js
// esm.mjs

export async function named() {
  return "named";
}

const defaultValue = "default";

export default defaultValue;
```

ã“ã®ã‚ˆã†ã«ä»Šã¾ã§ã§ããªã‹ã£ãŸCJSã‹ã‚‰ESMã‚’`require`çµŒç”±ã§å…¥ã‚Œã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã€å¾Œè¿°ã™ã‚‹æ—¢å­˜ã®ä»•çµ„ã¿ã‚’ç ´å£Šã›ãšã«ã‚·ãƒ³ãƒ—ãƒ«ã«è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ã‹ã—ã€Top Level Awaitã ã‘ã¯å¼•ãç¶šãã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ããªã„ç‚¹ã«æ³¨æ„ã§ã™ã€‚
`require`ã¯ã‚ãã¾ã§ã‚‚åŒæœŸãªé–¢æ•°ãªã®ã§ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã‚’éåŒæœŸã«å¤‰ãˆã¦ã—ã¾ã†TLAã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã›ã‚“ã€‚(`require`ã«é–¢ã‚ã‚‰ãšCJSè‡ªä½“ãŒTLAã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã¾ã›ã‚“)

```js
// esm.mjs
export async function named() {
  return "named";
}

await named();
```

```sh
node:internal/modules/esm/module_job:290
    this.module.instantiateSync();
                ^

Error: require() cannot be used on an ESM graph with top-level await. Use import() instead. To see where the top-level await comes from, use --experimental-print-required-tla.
    at ModuleJobSync.runSync (node:internal/modules/esm/module_job:290:17)
    at ModuleLoader.importSyncForRequire (node:internal/modules/esm/loader:301:16)
    at Object.loadESMFromCJS [as .mjs] (node:internal/modules/cjs/loader:1289:32)
    at Module.load (node:internal/modules/cjs/loader:1238:32)
    at Module._load (node:internal/modules/cjs/loader:1054:12)
    at Module.require (node:internal/modules/cjs/loader:1263:19)
    at require (node:internal/modules/helpers:179:18)
    at Object.<anonymous> (/Users/cont-y-hiroto/node/a/index.js:3:13)
    at Module._compile (node:internal/modules/cjs/loader:1420:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1498:10) {
  code: 'ERR_REQUIRE_ASYNC_MODULE'
}
```

æ–°ã—ãã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã€`ERR_REQUIRE_ASYNC_MODULE`ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

ã—ã‹ã—ã€PRã§JoyeeãŒæ›¸ã„ã¦ã„ã‚‹é€šã‚Šã€TLAã¯åŸºæœ¬çš„ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã—ã‹åˆ©ç”¨ã•ã‚Œãªã„ã®ã§ã“ã®ã‚±ãƒ¼ã‚¹ã¯ç„¡è¦–ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚
**ã¤ã¾ã‚Šä»Šå¾Œã€CJSã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã»ã¼å¤§åŠã®ã‚±ãƒ¼ã‚¹ã§importã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒESMã‹ã©ã†ã‹ã‚’æ°—ã«ã—ãªãã¦è‰¯ããªã‚Šã¾ã™ã€‚**

> This PR tries to keep it simple - only load ESM synchronously when we know it's synchronous (which is part of the design of ESM and is supported by the V8 API), and if it contains TLA, we throw. That should at least address the majority of use cases of ESM (TLA in a module that's supposed to be import'ed is already not a great idea, they are more meant for entry points. If they are really needed, users can use import() to make that asynchronicity explicit).

TLAã®å ´åˆã¯ã€å¼•ãç¶šãdynamic importã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

## ä»Šã¾ã§ã®ä»•çµ„ã¿

ä»Šæ—¥ã¾ã§ã€`.js`ãƒ•ã‚¡ã‚¤ãƒ«ã«ãŠã„ã¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå¤‰å‹•çš„ã«å¤‰ã‚ã‚‹ç‚¹ã€ã¾ãŸCJSã¨ESMã®ç›¸äº’é‹ç”¨æ€§ãŒé›£ã—ã„ç‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ±ºå®š

ä»¥ä¸‹ã®æ¡ä»¶ã§ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ±ºå®šã•ã‚Œã€importã™ã‚‹å ´åˆã¯ãã‚Œã«æº–æ‹ ã—ãŸæ–¹æ³•ã§è¡Œã‚ãªã„ã¨å‹•ãã¾ã›ã‚“ã€‚

#### Package Type (æ—§ Package Mode) ã§ã®æ±ºå®š

`package.json`ã«`type`ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ä¸€ç•ªè¿‘ãã®è¦ªã®`package.json`ã«ã‚ˆã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒç¢ºå®šã—ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯äº’æ›ã‚’ä¿ã¤ãŸã‚ã€CJSã¨ãªã£ã¦ãŠã‚Šã€ESMã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã¯ã€`type:module`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![pacakge type flow](../../assets/images/blog/nodejs-new-module-algorithm/flow.png)

è©³ã—ãã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

<OG url="https://hiroppy.me/blog/nodejs-experimental-modules" />

#### ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã§ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å›ºå®šã™ã‚‹

ESMã«ã—ãŸã„å ´åˆã¯`.mjs`ã€CJSã«ã—ãŸã„å ´åˆã¯`.cjs`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å›ºå®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### CJSã¨ESMé–“ã®è§£æ±ºæ–¹æ³•

ä»Šã¾ã§ç†è§£ã™ã‚‹ã®ã«é›£ã—ã‹ã£ãŸå•é¡Œã¯ã€CJSã¨ESMã®ç›¸äº’é‹ç”¨æ€§ã§ã™ã€‚
ãªãœé›£ã—ã„ã‹ã¨ã„ã†ã¨ã€ãƒ›ã‚¹ãƒˆãŒCJSã®å ´åˆã«importã•ã‚Œã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒESMãªã®ã‹CJSãªã®ã‹ã«ã‚ˆã£ã¦æ›¸ãæ–¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚

#### import CJS from ESM

ESMã‹ã‚‰CJSã‚’importã™ã‚‹å ´åˆã¯ã€ç‰¹ã«é›£ã—ããªãã€ãã®ã¾ã¾`import`ã‚’åˆ©ç”¨ã—ã„ã‚Œã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

#### import ESM from CJS

CJSã‹ã‚‰ESMã‚’importã™ã‚‹å ´åˆã¯ã€`require`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚å”¯ä¸€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ–¹æ³•ã¯ã€dynamic importã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

```js
// // Reading ESM at top-level is prohibited.
// import foo from './esm/foo.js'; // invalid

// // An error occurs because the read file is written as ESM.
// // `require` expects read file as CJS
// require('./esm/foo');
//
// // export default typeof module !== 'undefined' ? 'cjs' : 'esm';
// // ^^^^^^
// // SyntaxError: Unexpected token export

console.log("root.js:", typeof module !== "undefined" ? "cjs" : "esm"); // cjs

(async () => {
  const { default: foo } = await import("./esm/foo.js");
  console.log("foo.js :", foo); // esm
})();

// Conclusion
// ğŸ™†â€â™€ï¸ESM -> CJS
// ğŸ™…â€â™€ï¸CJS -> ESM (excluding dynamic import)
```

ã‚‚ã£ã¨è©³ã—ãç¾è¡Œã®Node.jsã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

<OG url="https://hiroppy.me/blog/node-esm" />

## ã¾ã¨ã‚

ã“ã®ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢è‡ªä½“ã¯[2019å¹´](https://github.com/nodejs/node/issues/49450)ã‹ã‚‰ã‚ã‚Šã€2018å¹´ã‹ã‚‰å§‹ã¾ã£ãŸModuleãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã§ã‚‚è­°è«–ã—ãŸçµæœã€å½“æ™‚ã¯å…¥ã‚Œã‚Œãšä»Šã®ã‚ˆã†ãªä»•çµ„ã¿ã«ãªã‚Šã¾ã—ãŸã€‚
2024å¹´ã«ãªã£ã¦ã‚‚ã€ä»Šã®è¤‡é›‘ãªä»•çµ„ã¿ã¯åˆ©ç”¨è€…ã«ã¨ã£ã¦è‹¦ç—›ã¨ãªã£ã¦ã„ã‚‹ã®ã§ä»Šå›ã€ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã«å†åº¦å€’ã‚Œã‚‹å½¢ã¨ãªã‚Šã¾ã—ãŸã€‚

æœ€åˆã‹ã‚‰ã€ã“ã®ã‚ˆã†ãªä»•çµ„ã¿ã«ã§ããŸã®ã§ã¯ãªã„ã‹ï¼Ÿã¨ã„ã†ç–‘å•ã¯èª°ã—ã‚‚ãŒæ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å½“æ™‚ã‹ã‚‰è­°è«–ã—ã¦ã„ã‚‹çµŒç·¯ãŒã‚ã£ãŸã“ã¨ã ã‘ã¯ç¢ºã‹ã§ã™ã€‚

---

- ä»Šã¾ã§
  - CJSã‹ã‚‰ESMã‚’èª­ã¿è¾¼ã‚€ã¨ãã¯ã€`require`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ããšã€dynamic importã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ
  - CJSã‹ã‚‰ãªã«ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ãã«ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒESMã‹CJSã‹ã‚’æ°—ã«ã—ãªã‘ã‚Œã°ãªã‚‰ãªã‹ã£ãŸ
- ã“ã‚Œã‹ã‚‰
  - CJSã‹ã‚‰ESMã‚’èª­ã¿è¾¼ã‚€ã¨ãã¯ã€`require`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
  - `require`ã§èª­ã¿è¾¼ã‚€ã¨ãã«ã€TLAã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
    - å¼•ãç¶šãdynamic importã‚’åˆ©ç”¨ã™ã‚‹
  - CJSã‹ã‚‰ãªã«ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ãã«ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒCJSã‹ESMã‹ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒã»ã¼ãªããªã£ãŸ

---
layout: ../../layouts/BlogLayout.astro
title: Node.jsã§TypeScriptã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚
date: 2024-07-08
description: Node.jsã§TypeScriptã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ãŒææ¡ˆã•ã‚Œã¾ã—ãŸ
image: /images/brands/nodejs.png
tags: javascript
---

import OG from "../../components/OG.astro";

<OG url="https://github.com/nodejs/node/pull/53725" />

ğŸ’â€â™€ï¸ ã¾ã ãƒãƒ¼ã‚¸ã•ã‚Œã¦ãªã„ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„

`--experimental-strip-types`ã¨ã„ã†ãƒ•ãƒ©ã‚°ã‚’å®Ÿè¡Œæ™‚ã«ä»˜ã‘ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€Node.jsã§TypeScriptã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹PRãŒå‡ºã¦ãã¾ã—ãŸã€‚

## èƒŒæ™¯

TC39ã§ã‚‚[å‹æ³¨é‡ˆã®è©±é¡Œ](https://github.com/tc39/proposal-type-annotations)(è­°äº‹éŒ²ã‚’èª­ã‚€ã¨ãªã‹ãªã‹ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã®å…¼ã­åˆã„ãŒã‚ã‚Šãƒã‚¤ãƒ†ã‚£ãƒ–ã¯é›£ã—ãã†ã§ã™ãŒ)ãŒå­˜åœ¨ã™ã‚‹ã»ã©JSã®ã‚³ãƒ¼ãƒ‰ã«ãŠã„ã¦ã€å‹ã¯å¿…é ˆã®ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚
Node.jsã¨åŒã˜ç«‹ã¡ä½ç½®ã§ã‚ã‚‹Denoã‚„Bunã¯TypeScriptã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€Node.jsã¯ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
ãªã®ã§æ™®æ®µã€TypeScriptã‚’åˆ©ç”¨ã™ã‚‹ã¨ãã«ã¯[ts-node](https://github.com/TypeStrong/ts-node)ã‚„[tsx](https://github.com/privatenumber/tsx)ãªã©ã®ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼ã€[esbuild-register](https://github.com/egoist/esbuild-register)ã®ã‚ˆã†ãªãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
æ™‚ä»£çš„ã«å¿…é ˆã®ã‚‚ã®ã¨ãªã£ã¦ã„ã‚‹ä»¥ä¸Šã€Node.jsã«ã‚‚ãƒã‚¤ãƒ†ã‚£ãƒ–ã§å…¥ã‚Œã¦ã„ãã¹ãã§ã¯ï¼Ÿã¨ã„ã†ã®ãŒèƒŒæ™¯ã¨ãªã‚Šã¾ã™ã€‚

## ã©ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã‹ï¼Ÿ

Node.jsã®å†…éƒ¨ã§ã¯ã€[@swc/wasm-typescript](https://swc.rs/docs/references/wasm-typescript)ã‚’å‹•ã‹ã—ã€
TypeScriptã®å‹ã‚’è½ã¨ã—ã¾ã™ã€‚`swc/core`ã‚„`esbuild`ã‚‚æ¤œè¨ã—ãŸã¨ã®ã“ã¨ã§ã™ãŒã€Rustã‚„Golangã‚’ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã«è¿½åŠ ã—ãªã„ã¨ã„ã‘ãªãã€
Wasmã¨ãªã‚Šã¾ã—ãŸã€‚Node.jsã¯C++ãŒãƒ™ãƒ¼ã‚¹ãªã®ã§Wasmã¯è‰¯ã„ä½¿ã„æ–¹ã ã¨æ„Ÿã˜ã¾ã™ã€‚çµæœçš„ã«Denoã‚‚Rustãƒ™ãƒ¼ã‚¹ã§`swc`ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ãªã‚Šã¾ã—ãŸã€‚

ã¡ãªã¿ã«`tsc`ã¯ã€8.5MBã‚‚ã‚ã‚‹ã®ã§ã€åˆ©ç”¨ã—ãªã‹ã£ãŸã¨ã®ã“ã¨ã§ã™ã€‚

æ¡ˆå¤–ã€ãã®å†…éƒ¨å®Ÿè£…ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ä»¥ä¸‹ã¯CJSã¸ã®å¤‰æ›ä¾‹ã§ã™ã€‚ESMã¯ã‚‚ã†å°‘ã—è¤‡é›‘ã§ã™ã€‚
å†…éƒ¨ã®module loaderã«`.ts`ã‹`.cts`æ‹¡å¼µå­ãªã‚‰ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚’ã™ã‚‹ã¨ã„ã†å‡¦ç†ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚

<details>

<summary>lib/internal/modules/cjs/loader.js</summary>

```js
Module._extensions[".ts"] = function (module, filename) {
  const content = getMaybeCachedSource(module, filename);
  const { parseTScode } = require("internal/modules/typescript/typescript");
  const code = parseTScode(content);
  const pkg = packageJsonReader.getNearestParentPackageJSON(filename);
  // Function require shouldn't be used in ES modules.
  if (pkg?.data.type === "module") {
    if (getOptionValue("--experimental-require-module")) {
      module._compile(content, filename, "module");
      return;
    }
    const parent = module[kModuleParent];
    const parentPath = parent?.filename;
    const packageJsonPath = path.resolve(pkg.path, "package.json");
    const usesEsm = containsModuleSyntax(code, filename);
    const err = new ERR_REQUIRE_ESM(
      filename,
      usesEsm,
      parentPath,
      packageJsonPath,
    );
    throw err;
  }
  module._compile(code, filename, "commonjs");
};

Module._extensions[".cts"] = function (module, filename) {
  const content = getMaybeCachedSource(module, filename);
  const { parseTScode } = require("internal/modules/typescript/typescript");
  const code = parseTScode(content);
  module._compile(code, filename, "commonjs");
};
```

</details>

<details>

<summary>lib/internal/modules/typescript/typescript.js</summary>

```js
"use strict";

const { stringify } = require("internal/modules/helpers");
const { transformSync } = require("internal/deps/swc/wasm");

function parseTScode(source) {
  const result = transformSync(stringify(source), {
    mode: "strip-only",
  });
  return result;
}

module.exports = {
  parseTScode,
};
```

</details>

ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹æ‹¡å¼µå­ã‚‚ã€`.ts`ã‚’ã¯ã˜ã‚`.cts`, `.mts`ãŒä¸€éƒ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€å¤‰æ›å¾Œã®JSã¯CJSã€ESMã®ã©ã¡ã‚‰ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

## æ³¨æ„ç‚¹

ã¾ã åˆæœŸPRãªã®ã§ã€ä»Šå¾Œæ”¹å–„ã•ã‚Œã¦ã„ãã¯ãšã§ã™ãŒã€ç¾æ®µéšã ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

### å‹æ¤œæŸ»ãŒã§ããªã„

`tsc`ã‚’ä½¿ã£ã¦ãªã„ã®ã§ã€å‹ãŒæ­£ã—ã„ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯Next.jsã¨ã‹ã¨åŒæ§˜ã§ã‚ãã¾ã§ã‚‚TypeScriptã‹ã‚‰JavaScriptã¸å¤‰æ›ã™ã‚‹ã ã‘ãªã®ã§ã€`tsc`ã¯å¼•ãç¶šãåˆ©ç”¨ã™ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```ts
// index.ts
const foo: string = 1;

console.log(foo);
```

```sh
$ ./node --experimental-strip-types index.ts
1
```

Node.jsã‚‚ã“ã®æµã‚Œã«ãªã‚‹ã¨ã€ã¾ãŸã“ã‚Œã‚’æ©Ÿä¼šã«[stc](https://github.com/dudykr/stc)ã¿ãŸã„ãªã™ã”ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ãŒå‡ºã¦ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### æ‹¡å¼µå­ã‚’çœç•¥ã—ãŸå ´åˆ

æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹æ™‚ã¯ã€æ‹¡å¼µå­ã‚’è¦‹ã¦TSã‹ã©ã†ã‹ã®åˆ¤æ–­ã‚’è¡Œã†ãŸã‚ã€æ‹¡å¼µå­ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã ã‚ã†ã¨æ€ã„ã¾ã™ã€‚
ç†æƒ³çš„ã«ã¯ã€æ‹¡å¼µå­ã¯æ›¸ã‹ãªãã¦ã‚‚å‹•ãã“ã¨ãªã®ã§ã€[nodejs/loaderså´](https://github.com/nodejs/loaders/issues/208)ã§ã“ã‚Œã‹ã‚‰è­°è«–ãŒãªã•ã‚Œã¦ã„ãã¾ã™ã€‚

```ts
// index.ts

// Error: Must use .ts extension when using TypeScript files
import { getDate } from "./getDate";

console.log(getDate());
```

```sh
$ ./node --experimental-strip-types index.ts

node:internal/modules/run_main:121
    triggerUncaughtException(
    ^

Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/Users/hiroppy/node/getDate' imported from /Users/hiroppy/node/index.ts
Did you mean to import "./getDate.ts"?
    at finalizeResolution (node:internal/modules/esm/resolve:260:11)
    at moduleResolve (node:internal/modules/esm/resolve:921:10)
    at defaultResolve (node:internal/modules/esm/resolve:1120:11)
    at ModuleLoader.defaultResolve (node:internal/modules/esm/loader:557:12)
    at ModuleLoader.resolve (node:internal/modules/esm/loader:526:25)
    at ModuleLoader.getModuleJob (node:internal/modules/esm/loader:249:38)
    at ModuleJob._link (node:internal/modules/esm/module_job:126:49) {
  code: 'ERR_MODULE_NOT_FOUND',
  url: 'file:///Users/hiroppy/node/getDate'
}

Node.js v23.0.0-pre
```

importã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«æ‹¡å¼µå­ã‚’ã¤ã‘ã‚‹ã¨å‹•ãã¾ã™ã€‚

```ts
// index.ts

import { getDate } from "./getDate.ts";

console.log(getDate());
```

```sh
2024-07-07T13:22:29.663Z
```

### TypeScriptå›ºæœ‰ã®æ©Ÿèƒ½ã¯ä½¿ãˆãªã„

`Enum`, `experimentalDecorators`, `namespaces`ãªã©ã®TypeScriptå›ºæœ‰ã®æ©Ÿèƒ½ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

```ts
// index.ts

enum Fruits {
  Apple,
  Orange,
  Pineapple,
}
```

```sh
$ ./node --experimental-strip-types index.ts

node:internal/modules/run_main:121
    triggerUncaughtException(
    ^
  x TypeScript enum is not supported in strip-only mode
   ,-[1:1]
 1 | ,-> enum Fruits {
 2 | |     Apple,
 3 | |     Orange,
 4 | |     Pineapple
 5 | `-> };
   `----

(Use `node --trace-uncaught ...` to show where the exception was thrown)

Node.js v23.0.0-pre
```

### ãã®ä»–

- REPL, `--print`, `--check`, `inspect`ã§ã¯åˆ©ç”¨ã§ããªã„
- ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„

## ã¾ã¨ã‚

- ã¾ã ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‹ã‚ã‹ã‚‰ãªã„ãŒã€Node.jsã§ç›´æ¥TypeScriptã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„
- åˆ©ç”¨ã§ãã‚‹æ‹¡å¼µå­ã¯ã€`.ts`, `.cts`, `.mts`
- å‹æ¤œæŸ»ã¯è¡Œãˆãªã„ã®ã§ã€åˆ¥é€”`tsc`ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ç¾æ®µéšã§ã¯ã€æ‹¡å¼µå­ã‚’æ›¸ã‹ãªã„ã¨TypeScriptã¨ã—ã¦åˆ¤æ–­ã—ãªã„
- TypeScriptå›ºæœ‰ã®æ©Ÿèƒ½ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„

ãƒ•ã‚¡ã‚¤ãƒ«é‡ã«ã‚ˆã£ã¦ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡ŒãŒå‡ºã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€
å°†æ¥çš„ã«node_moduleså†…ã®ã‚³ãƒ¼ãƒ‰ãŒTypeScriptã§æ›¸ã‹ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ãƒ‰ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã›ãšã«å®Ÿè¡Œã§ãã‚‹ã‹ã‚‚ã¨æ€ã†ã¨æ¥½ã—ã¿ã§ã™ã­ã€‚

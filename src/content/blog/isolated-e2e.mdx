---
title: "Playwrightã§å®Ÿéš›ã®DBã‚’ç”¨ã„ã¦ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã—é«˜é€ŸåŒ–ã™ã‚‹"
date: 2025-07-01T00:00:00.000Z
description: "LLMæ™‚ä»£ã«ãŠã‘ã‚‹e2eãƒ†ã‚¹ãƒˆã®é«˜é€ŸåŒ–ã¨å …ç‰¢æ€§å‘ä¸Šã®ãŸã‚ã®å®Ÿè·µçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç´¹ä»‹ã—ã¾ã™ã€‚"
image: /images/brands/playwright.png
tags: e2e,testing,node.js
---

import { OG } from "../../mdx/components/OG";

æœ€è¿‘ã¯ã€LLMã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒæ—¥å¸¸çš„ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãã‚Œã«ä¼´ã£ã¦ã€ãƒ†ã‚¹ãƒˆã¯ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã«ä»Šå¾Œæ›´ã«é‡è¦ã«ãªã£ã¦ã„ãã¾ã™ã€‚
ãã“ã§LLMã«ã¨ã£ã¦ã‚‚äººé–“ã«ã¨ã£ã¦ã‚‚ã€å®Ÿè¡Œé€Ÿåº¦ãŒé‡è¦ãªè¦ç´ ã¨ãªã‚Šã¾ã™ãŒã€ç‰¹ã«e2eã¯å®Ÿè¡Œé€Ÿåº¦ãŒé…ã„ç‚¹ãŒèª²é¡Œã§ã™ã€‚

ã•ã‚‰ã«å®Ÿéš›ã®DBã‚’ç”¨ã„ãŸãƒ†ã‚¹ãƒˆã‚’è¡Œã†éš›ã€ä¸¦åˆ—ã«å®Ÿè¡Œã—ãŸå ´åˆã«ã¯ãƒ†ã‚¹ãƒˆå…¨ä½“ã‚’å†ªç­‰ã«ã™ã‚‹ã“ã¨ã¯é›£ã—ãã€ç›´åˆ—å®Ÿè¡ŒãŒä¸€èˆ¬çš„ã§ã™ã€‚(GitHub Actionsã®matrixã‚„ã‚³ãƒ³ãƒ†ãƒŠã§éš”é›¢ã™ã‚Œã°å¯èƒ½)

ä»Šå›ã¯ã€å®Ÿéš›ã®DBã‚’ç”¨ã„ã¤ã¤ã€ä¸¦åˆ—ã«å®Ÿè¡Œã—ã€e2eå…¨ä½“ã®å®Ÿè¡Œæ™‚é–“ã‚’å¤§å¹…ã«çŸ­ç¸®ã—ã¤ã¤å …ç‰¢ã«ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã™ã€‚

## ä»Šå›ä½¿ç”¨ã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- Next.js
- NextAuth.js
- Prisma
- PostgreSQL
- Playwright
- Testcontainers

> [!NOTE]
> ä»Šå›ã¯ã€next-authã®æˆ¦ç•¥ã¯JWTã‚’åˆ©ç”¨ã—ã¾ã™

## Playwrightã®å•é¡Œç‚¹

[webserver](https://playwright.dev/docs/test-webserver)ã¯ã€å˜ä¸€ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã®ã¿ã—ã‹ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€ã“ã‚Œã«ä¾å­˜ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
Playwrightã¯è¤‡æ•°ã®APPã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ãªã„ãŸã‚ã€ã‚‚ã¡ã‚ã‚“ãƒãƒ¼ãƒˆã®ç®¡ç†ãªã©ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚APIã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã§ãã‚‹ã‚‚ã®ã®ç‰¹ã«åˆ©ç”¨ã§ãã‚‹ã‚‚ã®ã‚‚ãªã„ãŸã‚ã“ã“ã¯è‡ªåˆ†ãŸã¡ã§å¯¾å¿œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## å…¨ä½“ã®æµã‚Œ

1. APPå´ã§èªè¨¼ã‚’é€šã‚‹ã‚ˆã†ã«ã™ã‚‹
2. ãƒ†ã‚¹ãƒˆã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã‚’å…¨ä½“ã®ãƒ†ã‚¹ãƒˆå‰ã«è¡Œã„ã€`storageState`ã¨ã—ã¦ä¿å­˜ã—ã€å„ãƒ†ã‚¹ãƒˆã¯èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
3. å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ã€å‹•çš„ã«PostgreSQLã‚³ãƒ³ãƒ†ãƒŠã¨APPã‚’èµ·å‹•ã™ã‚‹
4. å„ãƒ†ã‚¹ãƒˆã¯ã€`afterEach`ã§DBã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
5. å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ãƒ†ã‚¹ãƒˆãŒçµ‚äº†æ¬¡ç¬¬ã€DBã®ç ´æ£„ã¨APPã®çµ‚äº†ã‚’è¡Œã†

## APPå´ã§èªè¨¼ã‚’é€šã‚‹ã‚ˆã†ã«ã™ã‚‹

Googleãªã©ã®èªè¨¼ã‚’e2eã§çªç ´ã™ã‚‹ã®ã¯å¤§å¤‰ãªã®ã§ã€ã‚ã¾ã‚Šã‚„ã‚ŠãŸããªã„ã§ã™ãŒã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§å½è£…ã—ã¾ã™ã€‚
`NEXTAUTH_TEST_MODE === "true"`ã®ã¨ãã«ã€JWTã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰å‡¦ç†ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚

<OG url="https://zenn.dev/moozaru/articles/e35ce8e47ac805" />

<br />

```ts {3-16} {25}
import type { NextAuthConfig } from "next-auth";

export const configForTest = {
  jwt: {
    encode: async ({ token }) => {
      return btoa(JSON.stringify(token));
    },
    decode: async ({ token }) => {
      if (!token) {
        return {};
      }

      return JSON.parse(atob(token));
    },
  },
} satisfies Omit<NextAuthConfig, "providers">;

export const config = {
  providers: [],
  callbacks: {
    session: ({ session }) => {
      return session;
    },
  },
  ...(process.env.NEXTAUTH_TEST_MODE === "true" ? configForTest : {}),
} satisfies NextAuthConfig;
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã‚’äº‹å‰ã«ä½œæˆã™ã‚‹

æ¯å›ã®ãƒ†ã‚¹ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã€å®Ÿè¡Œæ™‚é–“ã®è¦³ç‚¹ã‹ã‚‰éåŠ¹ç‡çš„ã§ã™ã€‚
Playwrightã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã‚’äº‹å‰ã«`storageState`ã¨ã—ã¦ä¿å­˜ã—ã¦ãŠãã“ã¨ã§ã€å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ã¯ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®çŠ¶æ…‹ã‹ã‚‰é–‹å§‹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`e2e/.auth`ã«ãã‚Œãã‚Œã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼çŠ¶æ…‹ãŒjsonã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚

<OG url="https://playwright.dev/docs/auth" />

::: code-group

```ts [e2e/dummyUsers.ts]
import type { User } from "next-auth";

export const user1: User = {
  id: "id1",
  name: "user1",
  email: "user1@a.com",
  image:
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAMElEQVR42u3OMQEAAAQAMDrpp4Zuyojh2RIsa7bjUQoICAgICAgICAgICAgICHwHDhv0ROEuXMGUAAAAAElFTkSuQmCC",
  role: "USER",
};
```

```ts [playwright.config.ts]
import { defineConfig, devices } from "@playwright/test";

export default defineConfig({
  testDir: "./e2e",
  fullyParallel: true, // ä¸¦åˆ—å®Ÿè¡Œã•ã›ã‚‹
  projects: [
    {
      name: "setup",
      testMatch: /.\/e2e\/setup\/.*.ts/,
    },
    {
      name: "chrome",
      use: {
        ...devices["Desktop Chrome"],
      },
      dependencies: ["setup"], // setupã®å¾Œã«å®Ÿè¡Œ
    },
  ],
});
```

```ts [e2e/helpers/users.ts]
import type { BrowserContext, TestType } from "@playwright/test";
import type { User } from "next-auth";
import type { JWT } from "next-auth/jwt";

export async function createUserAuthState(context: BrowserContext, jwt: JWT) {
  // Next.jsã®NextAuthã§ä½¿ç”¨ã•ã‚Œã‚‹Cookieã‚’æ‰‹å‹•ã§è¨­å®š
  // å®Ÿéš›ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‚’çœç•¥ã—ã€èªè¨¼æ¸ˆã¿çŠ¶æ…‹ã‚’ç›´æ¥ä½œæˆ
  await context.addCookies([
    {
      name: "next-auth.session-token",
      value: btoa(
        JSON.stringify({
          ...jwt,
          sub: jwt.user.id,
        }),
      ),
      domain: "localhost",
      path: "/",
      httpOnly: true,
      sameSite: "Lax",
      expires: Math.round((Date.now() + 60 * 60 * 24 * 1000 * 7) / 1000),
    },
  ]);

  // ãƒ–ãƒ©ã‚¦ã‚¶ã®èªè¨¼çŠ¶æ…‹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã€å„ãƒ†ã‚¹ãƒˆã§ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã«ã‚ˆã‚Šèªè¨¼æ¸ˆã¿çŠ¶æ…‹ã‚’å¾©å…ƒ
  await context.storageState({
    path: getStorageStatePath(jwt.user.id ?? ""),
  });
}
```

```ts [e2e/setup/auth.ts]
import { test as setup } from "@playwright/test";
import { user1 } from "../dummyUsers";
import { createUserAuthState } from "../helpers/users";

setup("Create user1 auth", async ({ context }) => {
  await createUserAuthState(context, {
    user: user1,
  });
});
```

:::

## ãƒ¯ãƒ¼ã‚«ãƒ¼ã”ã¨ã®ç‹¬ç«‹ã—ãŸç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹

è¤‡æ•°ã®DBã¨APPã‚’ä¸¦åˆ—ã«èµ·å‹•ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒç‹¬ç«‹ã—ãŸç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### å‹•çš„ã«DBã‚’èµ·å‹•ã•ã›ã‚‹æº–å‚™ã‚’ã™ã‚‹

Testcontainersã‚’ç”¨ã„ã¦ã€PostgreSQLã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å‹•çš„ã«èµ·å‹•ã—ã€å„ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆé–“ã§ã®ãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚’é˜²ãã¾ã™ã€‚

<OG url="https://testcontainers.com/" />

ä»Šå›ã¯ã€dockerã®`compose`ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€ãã†ã§ãªã„å ´åˆã¯`GenericContainer`ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚portã‚’`0`ã«ã—ã¦ãŠãã“ã¨ã«ã‚ˆã‚Šã€ç©ºã„ã¦ã„ã‚‹ãƒãƒ¼ãƒˆã«å‹æ‰‹ã«ã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¾ã™ã€‚

ã“ã“ã§ã¯ç«¶åˆãƒãƒ¼ãƒˆã‚’é¿ã‘ã‚‹å‡¦ç†ã¨èµ·å‹•ã¾ã§ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

::: code-group

```yaml [compose.yml]
services:
  db:
    image: postgres:17
    ports:
      - "${DATABASE_PORT:-5432}:5432" # å‹•çš„ãƒãƒ¼ãƒˆå¯¾å¿œã®ãŸã‚ã€ä¸Šæ›¸ãã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
    environment:
      POSTGRES_DB: testdb
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
```

```ts [tests/db.setup.ts]
import { exec } from "node:child_process";
import { promisify } from "node:util";
import { DockerComposeEnvironment, Wait } from "testcontainers";
import { Prisma, PrismaClient } from "../src/app/__generated__/prisma";
import { createDBUrl } from "../src/app/_utils/db";

const execAsync = promisify(exec);

export async function setupDB({ port }: { port: "random" | number }) {
  const container = await new DockerComposeEnvironment(".", "compose.yml")
    .withEnvironmentFile(".env.test") // ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«
    .withEnvironment({
      // 0ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§OSãŒè‡ªå‹•çš„ã«ç©ºããƒãƒ¼ãƒˆã‚’å‰²ã‚Šå½“ã¦
      DATABASE_PORT: port === "random" ? "0" : `${port}`,
    })
    .withWaitStrategy("db", Wait.forListeningPorts())
    .up(["db"]);

  const dbContainer = container.getContainer("db-1");
  const mappedPort = dbContainer.getMappedPort(5432);
  const url = createDBUrl({
    host: dbContainer.getHost(),
    port: mappedPort,
  });

  // migrate
  await execAsync(`DATABASE_URL=${url} npx prisma db push`);

  const prisma = new PrismaClient({ datasources: { db: { url } } });

  async function down() {
    await prisma.$disconnect();
    await container.down();
  }

  return {
    url,
    container,
    port: mappedPort,
    prisma,
    down,
    async [Symbol.asyncDispose]() {
      await down();
    },
  } as const;
}
```

:::

ã¡ãªã¿ã«`db.setup.ts`ã¯vitestã§ä¸¦åˆ—ã«DBã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€å…±é€šåŒ–ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚

### å‹•çš„ã«APPã‚’èµ·å‹•ã™ã‚‹æº–å‚™

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®éš”é›¢ã¨åŒæ§˜ã«ã€å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ç‹¬è‡ªã®ãƒãƒ¼ãƒˆã§Next.jsã‚’èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`baseURL`ã‚„ã€`dbPort`ã€`appPort`ã‚’å®Ÿè¡Œæ™‚ã«ç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãã—ã€å„ç¨®ãƒãƒ¼ãƒˆã‚„å‘ãå…ˆã‚’å¤‰æ›´ã—ã¾ã™ã€‚
ã¾ãŸã€ãƒãƒ¼ãƒˆã®ç¢ºç‡ã‚„ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚‚ç”¨æ„ã—ã¾ã™ã€‚[get-port](https://www.npmjs.com/package/get-port)ã‚’åˆ©ç”¨ã—ã¦ã‚‚ã„ã„ã§ã™ã€‚

ã“ã“ã§ã‚‚ç«¶åˆãƒãƒ¼ãƒˆã‚’é¿ã‘ã‚‹å‡¦ç†ã¨èµ·å‹•ã¾ã§ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

::: code-group

```ts [e2e/helpers/setupApp.ts]
import { exec } from "node:child_process";
import { getRandomPort } from "./getRandomPort";
import { waitForHealth } from "./waitForHealth";

export async function setupApp(dbPort: number) {
  const appPort = await getRandomPort();
  const baseURL = `http://localhost:${appPort}`;
  const cp = exec(
    `NEXTAUTH_URL=${baseURL} DATABASE_PORT=${dbPort} pnpm start --port ${appPort}`,
  );
  await waitForHealth(baseURL);

  return {
    appPort,
    baseURL,
    async [Symbol.asyncDispose]() {
      if (cp.pid) {
        process.kill(cp.pid);
      }
    },
  } as const;
}
```

```ts [e2e/helpers/getRandomPort.ts]
import { createServer } from "node:http";

export async function getRandomPort() {
  return new Promise<number>((resolve) => {
    const server = createServer();

    server.listen(0, () => {
      const address = server.address();
      const port = address && typeof address === "object" ? address.port : null;

      if (port) {
        server.close();
        resolve(port);
      }
    });
  });
}
```

```ts [e2e/helpers/waitForHealth.ts]
import { setTimeout } from "node:timers/promises";

export async function waitForHealth(baseUrl: string) {
  const maxAttempts = 30;
  const interval = 100;
  const healthUrl = `${baseUrl}/api/health`;
  let attempts = 0;

  while (attempts < maxAttempts) {
    try {
      const response = await fetch(healthUrl);

      if (response.ok) {
        const data = await response.json();

        if (data.status === "ok") {
          return;
        }
      }
    } catch {}

    attempts++;
    await setTimeout(interval);
  }

  throw new Error(`Server health check failed after ${maxAttempts} attempts`);
}
```

:::

### fixturesã§DBã¨APPã‚’èµ·å‹•ã™ã‚‹

æ¬¡ã«ã€Playwrightã®`fixtures`ã‚’åˆ©ç”¨ã—ã¦ã€å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
`worker`ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©ã—ã€workerãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã«èµ·å‹•ã®setupã‚’è‡ªå‹•ã§è¡Œã„ã¾ã™ã€‚
`use`ã®å‰ãŒãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã¨ãªã‚‹ã®ã§ã€å®Ÿè¡Œå‰ã«DBã‚„APPã‚’èµ·å‹•ã—ã€ã‚‚ã—å¾Œå‡¦ç†ãŒå¿…è¦ã§ã‚ã‚Œã°ã€`use`ã®å¾Œã«æ›¸ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

<OG url="https://playwright.dev/docs/test-fixtures#worker-scoped-fixtures" />

::: code-group

```ts [e2e/fixtures.ts]
import { test as base } from "@playwright/test";
import type { User } from "next-auth";
import { setupDB } from "../tests/db.setup";
import { setupApp } from "./helpers/app";
import { generatePrismaClient } from "./helpers/prisma";

export type TestFixtures = {};

export type WorkerFixtures = {
  setup: Awaited<{
    prisma: Awaited<ReturnType<typeof setupDB>>["prisma"];
    appPort: number;
    baseURL: string;
    dbURL: string;
  }>;
};

export const test = base.extend<TestFixtures, WorkerFixtures>({
  setup: [
    async ({ browser }, use) => {
      await using dbSetup = await setupDB({ port: "random" });
      await using appSetup = await setupApp(dbSetup.port);
      const baseURL = appSetup.baseURL;
      const originalNewContext = browser.newContext.bind(browser);

      // æ–°ã—ã„baseURLã‚’å«ã‚“ã ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–°ãŸã«ä½œæˆ
      browser.newContext = async () => {
        return originalNewContext({ baseURL });
      };

      await use({
        prisma: dbSetup.prisma,
        appPort: appSetup.appPort,
        baseURL,
        dbURL: dbSetup.url,
      });
    },
    {
      scope: "worker",
      auto: true,
    },
  ],
});
```

```ts [e2e/helpers/prisma.ts]
import { PrismaClient } from "../../src/app/__generated__/prisma";

export async function generatePrismaClient(url: string) {
  const prisma = new PrismaClient({
    datasources: {
      db: {
        url,
      },
    },
  });

  return {
    prisma,
    async [Symbol.asyncDispose]() {
      await prisma.$disconnect();
    },
  } as const;
}
```

:::

## ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

æœ€åˆã«ä½œæˆã—ãŸãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
`fixtures`ã«userã‚’DBã¸ç™»éŒ²ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¨cookieã¨DBã‚’é£›ã°ã™ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚(å³å¯†ã«ã¯`User`ã ã‘ã‚’é£›ã°ã—ãŸã»ã†ãŒã„ã„ãŒã€`afterEach`ã§é£›ã°ã—ã¦ã„ã‚‹ã®ã§ä¸€ç·’)

`setup`ã¯`fixtures`ã§å®šç¾©ã—ã¦ã„ã‚‹ã®ã§ã€`registerToDB`ã‚„`reset`ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã€DBã‚„APPã®ãƒãƒ¼ãƒˆãªã©ã®çŠ¶æ…‹ã‚’å–å¾—ã§ãã¾ã™ã€‚

::: code-group

```ts [e2e/fixtures.ts] collapse={15-20, 25-48} collapseStyle="collapsible-start"
import { test as base } from "@playwright/test";
import type { User } from "next-auth";
import { setupDB } from "../tests/db.setup";
import { setupApp } from "./helpers/app";
import { generatePrismaClient } from "./helpers/prisma";
import { registerUserToDB } from "./helpers/users";

export type TestFixtures = {
  storageState: string;
  registerToDB: (user: User) => Promise<void>;
  reset: () => Promise<void>;
};

export type WorkerFixtures = {
  setup: Awaited<{
    prisma: Awaited<ReturnType<typeof setupDB>>["prisma"];
    appPort: number;
    baseURL: string;
    dbURL: string;
  }>;
};

export const test = base.extend<TestFixtures, WorkerFixtures>({
  setup: [
    async ({ browser }, use) => {
      await using dbSetup = await setupDB({ port: "random" });
      await using appSetup = await setupApp(dbSetup.port);
      const baseURL = appSetup.baseURL;
      const originalNewContext = browser.newContext.bind(browser);

      // æ–°ã—ã„baseURLã‚’å«ã‚“ã ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–°ãŸã«ä½œæˆ
      browser.newContext = async () => {
        return originalNewContext({
          baseURL,
        });
      };

      await use({
        prisma: dbSetup.prisma,
        appPort: appSetup.appPort,
        baseURL,
        dbURL: dbSetup.url,
      });
    },
    {
      scope: "worker",
      auto: true,
    },
  ],
  registerToDB: async ({ reset, setup }, use) => {
    await use(async (user: User) => {
      await registerUserToDB(user, setup.dbURL);
    });
    await reset();
  },
  reset: ({ context, setup }, use) => {
    use(async () => {
      await using db = await generatePrismaClient(setup.dbURL);
      await Promise.all([truncate(db.prisma), context.clearCookies()]);
    });
  },
});
```

```ts [e2e/helpers/users.ts] collapse={28-47} collapseStyle="collapsible-start"
import type { BrowserContext, TestType } from "@playwright/test";
import type { User } from "next-auth";
import type { JWT } from "next-auth/jwt";
import type { TestFixtures, WorkerFixtures } from "../fixtures";
import { generatePrismaClient } from "./prisma";

export async function registerUserToDB(user: User, dbUrl: string) {
  await using db = await generatePrismaClient(dbUrl);
  await db.prisma.user.create({
    data: {
      ...user,
      accounts: {
        create: {
          type: "oauth",
          provider: "google",
          providerAccountId: `${Math.random()}`,
          id_token: "id_token",
          access_token: "access_token",
          token_type: "Bearer",
          scope: "scope",
        },
      },
    },
  });
}

export async function createUserAuthState(context: BrowserContext, jwt: JWT) {
  await context.addCookies([
    {
      name: "authjs.session-token",
      value: btoa(
        JSON.stringify({
          ...jwt,
          // google provider attaches `sub` to the token
          sub: jwt.user.id,
        }),
      ),
      domain: "localhost",
      path: "/",
      httpOnly: true,
      sameSite: "Lax",
      expires: Math.round((Date.now() + 60 * 60 * 24 * 1000 * 7) / 1000),
    },
  ]);
  await context.storageState({
    path: getStorageStatePath(jwt.user.id ?? ""),
  });
}

export async function useUser<T extends TestType<TestFixtures, WorkerFixtures>>(
  test: T,
  user: User,
) {
  test.use({ storageState: getStorageStatePath(user.id) });
  // æ¯ãƒ†ã‚¹ãƒˆã”ã¨ã«DBã«ã‚‚userã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãŠã
  test.beforeEach(async ({ registerToDB: registerToDB }) => {
    await registerToDB(user);
  });
}

function getStorageStatePath(id: string) {
  return `e2e/.auth/${id}.json`;
}
```

:::

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

## ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

ä»Šå›ã¯ã€[Page Object Models](https://playwright.dev/docs/pom)ã‚’æ¡ç”¨ã—ã€`fixtures`çµŒç”±ã§ãƒšãƒ¼ã‚¸ãã‚Œãã‚Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

::: code-group

```ts [e2e/integrations/auth.ts]
import { user1 } from "../dummyUsers";
import { test } from "../fixtures";
import { useUser } from "../helpers/users";

test.describe("no sign in", () => {
  test("should redirect to signIn page", async ({ topPage, signInPage }) => {
    await topPage.goTo();
    await signInPage.expectUI();
  });
});

test.describe("sign in", () => {
  useUser(test, user1);

  test("should show my name", async ({ topPage }) => {
    await topPage.goTo();
    await topPage.expectUI("signIn", user1);
  });
});
```

```ts [e2e/models/TopPage.ts]
import { type Locator, type Page, expect } from "@playwright/test";
import type { User } from "next-auth";
import { Base } from "./Base";

export class TopPage extends Base {
  textUserStatusLabelLocator: Locator;

  constructor(page: Page) {
    super(page);

    this.textUserStatusLabelLocator = this.page.locator(
      '[aria-label="User status"]',
    );
  }

  async goTo() {
    return await this.page.goto("/");
  }

  async expectUI(state: "signIn" | "signOut", user?: User) {
    if (state === "signIn") {
      await expect(this.textUserStatusLabelLocator).toContainText(
        `you are signed in as ${user?.name} ğŸ˜„`,
      );
    }

    if (state === "signOut") {
      await expect(this.textUserStatusLabelLocator).toContainText(
        "you are not signed in ğŸ¥²",
      );
    }
  }
}
```

```ts [e2e/fixtures.ts] collapse={11-14,18-23,31-54,57-60,63-66} collapseStyle="collapsible-start"
import { test as base } from "@playwright/test";
import type { User } from "next-auth";
import { setupDB, truncate } from "../tests/db.setup";
import { setupApp } from "./helpers/app";
import { generatePrismaClient } from "./helpers/prisma";
import { registerUserToDB } from "./helpers/users";
import { TopPage } from "./models/TopPage";

export type TestFixtures = {
  topPage: TopPage;
  storageState: string;
  registerToDB: (user: User) => Promise<void>;
  reset: () => Promise<void>;
  a11y: () => AxeBuilder;
};

export type WorkerFixtures = {
  setup: Awaited<{
    prisma: Awaited<ReturnType<typeof setupDB>>["prisma"];
    appPort: number;
    baseURL: string;
    dbURL: string;
  }>;
};

export const test = base.extend<TestFixtures, WorkerFixtures>({
  topPage: ({ page }, use) => {
    use(new TopPage(page));
  },
  setup: [
    async ({ browser }, use) => {
      await using dbSetup = await setupDB({ port: "random" });
      await using appSetup = await setupApp(dbSetup.port);
      const baseURL = appSetup.baseURL;
      const originalNewContext = browser.newContext.bind(browser);

      // æ–°ã—ã„baseURLã‚’å«ã‚“ã ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–°ãŸã«ä½œæˆ
      browser.newContext = async () => {
        return originalNewContext({
          baseURL,
        });
      };

      await use({
        prisma: dbSetup.prisma,
        appPort: appSetup.appPort,
        baseURL,
        dbURL: dbSetup.url,
      });
    },
    {
      scope: "worker",
      auto: true,
    },
  ],
  registerToDB: async ({ reset, setup }, use) => {
    await use(async (user: User) => {
      await registerUserToDB(user, setup.dbURL);
    });
    await reset();
  },
  reset: ({ context, setup }, use) => {
    use(async () => {
      await using db = await generatePrismaClient(setup.dbURL);
      await Promise.all([truncate(db.prisma), context.clearCookies()]);
    });
  },
});
```

:::

æ³¨æ„ç‚¹ãŒä¸€ã¤ã‚ã‚Šã€`useUser`(èªè¨¼çŠ¶æ…‹ã®å¾©å…ƒ)ã¯`page.context.storageState`ã®åˆ¶ç´„ä¸Šã€`page`ãŒä½œã‚‰ã‚Œã‚‹å‰ã«è¿½åŠ ã—ãªã„ã¨ã„ã‘ãªã„ã®ã§`test`ã®å‰ã«å®Ÿè¡ŒãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚
ãªã®ã§`test.describe`ã®ä¸­ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯`describe`ã¨ãªã‚Šã¾ã™ã€‚

```ts
import { user1 } from "../dummyUsers";
import { test } from "../fixtures";
import { useUser } from "../helpers/users";

test.describe("sign in", () => {
  useUser(test, user1);

  test("should show my name", async ({ topPage }) => {
    await topPage.goTo();
    await topPage.expectUI("signIn", user1);
  });
});
```

<br />

<OG url="https://playwright.dev/docs/auth#multiple-signed-in-roles" />

ã“ã‚Œã§å®Ÿéš›ã®DBã‚’ç”¨ã„ã¦ä¸¦åˆ—ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã€e2eã®å®Ÿè¡Œæ™‚é–“ãŒå¤§å¹…ã«çŸ­ç¸®ã•ã‚Œã¾ã—ãŸã€‚ã¨ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã ã¨10åˆ†ã‹ã‚‰3åˆ†ãã‚‰ã„ã‹ã‚ã‚Šã¾ã—ãŸã€‚

## ã¾ã¨ã‚

ä¸‹åœ°ã‚’ä½œã‚‹ã®ãŒå¤§å¤‰ã§ã™ãŒã€ã“ã‚Œã‚’ä¸€åº¦ä½œã£ã¦ã—ã¾ãˆã°ã€ã‚ã¨ã¯å„ãƒ†ã‚¹ãƒˆã§èªè¨¼ãŒå¿…è¦ã§ã‚ã‚Œã°`useUser`ã‚’ä½¿ã†ã ã‘ã§ã€å®Ÿéš›ã®DBã‚’ç”¨ã„ãŸä¸¦åˆ—ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ç‰¹ã«LLMã‚’æ´»ç”¨ã—ãŸé–‹ç™ºãŒå¢—ãˆã¦ã„ã‚‹ç¾åœ¨ã«ãŠã„ã¦ã€ã“ã®ã‚ˆã†ãªå …ç‰¢ãªãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰ã¨å®Ÿè¡Œæ™‚é–“ã¯ä»Šå¾Œã‚‚æœ€ä½é™å¿…è¦ãªã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã¨ãªã‚‹ã®ã ã¨æ€ã„ã¾ã™ã€‚

---

é¡ä¼¼ã®å†…å®¹ã§unit testã§ã®å®Ÿè£…ã¯ä»¥ä¸‹ã‚’å‚ç…§

<OG url="https://hiroppy.me/blog/testcontainers-parallel-tests" />

ãƒªãƒã‚¸ãƒˆãƒªã¯ä»¥ä¸‹ã‚’å‚ç…§

<OG url="https://github.com/hiroppy/web-app-template" />

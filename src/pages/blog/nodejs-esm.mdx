---
layout: ../../layouts/BlogLayout.astro
title: Node.jsã¨ECMAScript Modules
date: 2018-03-22
description: Node.jsã«å…¥ã‚‹ECMAScript Mdoulesã®ç‰¹å¾´ã‚’ç´¹ä»‹ã—ã¾ã™
image: /images/brands/nodejs.png
tags: javascript
hatenaPath: nodejs-esm
---

import OG from "../../components/OG.astro";

Node.js ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 10 ã®ãƒªãƒªãƒ¼ã‚¹ã¯ 4/25 ã‚’äºˆå®šã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€ECMAScript Modules ã¯ Stability1(å®Ÿé¨“çš„)ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã™ã€‚

è­°è«–ã¯ä»¥ä¸‹ã§è¡Œã‚ã‚Œã¾ã™ã€‚

<OG url="https://github.com/nodejs/modules" />

ä»¥ä¸‹ã€ECMAScript Modules ã‚’ ESMã€ CommonJS Modules ã‚’ CJS ã¨ç•¥ã—ã¾ã™ã€‚

<OG url="https://nodejs.org/api/esm.html" />

## è¦šãˆã¦ãŠãã¹ãã“ã¨

##### ESM ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€æ‹¡å¼µå­ã‚’`.mjs`ã«ã™ã‚‹

`.js`ãƒ•ã‚¡ã‚¤ãƒ«ã§`import/export`ã¯ä½¿ãˆã¾ã›ã‚“ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯`type="module"`ã¨ãªã‚Šã¾ã™ãŒã€Node.js ã§ã¯æ‹¡å¼µå­ã§åˆ¤æ–­ã—ã¾ã™ã€‚

##### `.mjs`ã®æ‹¡å¼µå­ã¯çœç•¥å¯èƒ½ã§ã‚ã‚‹

æ‹¡å¼µå­ã®æ¢æŸ»é †ã¯ ESM ã®æ™‚ã€`.mjs`ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
ã—ã‹ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚ãã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã„ãŸã„å ´åˆã€æ‹¡å¼µå­ã®çœç•¥ã¯ Node ç‹¬è‡ªã®æ©Ÿæ§‹ã§ã‚ã‚‹ãŸã‚çœç•¥ã¯ã—ãªã„ã»ã†ãŒã„ã„ã§ã—ã‚‡ã†ã€‚

##### ESM ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ã¯ CJS ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡ºæ¥ãªã„

ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ã€`import`ã‚’ä½¿ã†ã“ã¨ã¯è¨±ã•ã‚Œã¾ã›ã‚“ã€‚
ã—ã‹ã—ã€`dynamic import`ã¯ä¾‹å¤–çš„ã« CJS ã§ã‚‚ä½¿ãˆã‚‹ã®ã§ä¸€å¿œã€CJS ã‹ã‚‰ ESM ã®èª­ã¿è¾¼ã¿ã¯è¡Œãˆã¾ã™ã€‚

##### CJS ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã®ã« named import ã¯è¡Œãˆãªã„

`import {x} from 'y'`ã®æ›¸ãæ–¹ã¯ã§ãã¾ã›ã‚“ã€‚
CJS ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`default`ã§åŒ…ã¾ã‚Œã‚‹ãŸã‚ã§ã™ã€‚
ãªã®ã§ã€ã‚‚ã—è¡Œã„ãŸã„å ´åˆã¯ã€ä¸€åº¦`default`ã« alias ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
webpack4 ã‚‚ãã®ã‚ˆã†ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

<OG url="http://blog.hiroppy.me/entry/migrate-to-webpack4#ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—" />

**Babel ã§ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã¯`import { readFile } from 'fs'`ç­‰ã®æ›¸ãæ–¹ãŒã§ãã¦ã—ã¾ã†ãŸã‚ã€ãã®ã¾ã¾ Node ã¸ç§»ã™ã¨å£Šã‚Œã¾ã™ã€‚**

##### ESM ã®ãƒ‘ã‚¹ã¯ whatwg url ã«æº–æ‹ ã—ã¦ã„ã‚‹

Node9 ã§ whawg url ã¯ Stability2 ã«ãªã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶åŒæ§˜ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« URL ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç½®ã‹ã‚Œã¾ã—ãŸã€‚
ä»Šã¾ã§ã¯ã€`require('url').URL`ã§ã—ãŸã€‚
ã‚‚ã—ã‚¯ã‚¨ãƒªãƒ¼(`?`)ãŒç•°ãªã‚‹å ´åˆã¯ã€ãŸã¨ãˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚è¤‡æ•°å›ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```javascript
import "./foo?query=1"; // ?query=1ã¨ã—ã¦ã®fooãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
import "./foo?query=2"; // ?query=2ã¨ã—ã¦ã®fooãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
import "file:///xxx/foo";
```

##### Node ã®å¤‰æ•°ã§ã‚ã‚‹ã€`__dirname`ã‚„`__filename`ç­‰ãŒä½¿ãˆãªã„

stage-3 ã®`import.meta`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

<OG url="https://github.com/tc39/proposal-import-meta" />

<br />

```javascript
// index.mjs
console.log(import.meta);
// { url: 'file:///xxx/index.mjs' }
```

<br />

##### `.mjs`ã¯å³æ ¼ãƒ¢ãƒ¼ãƒ‰(`use strict`)ã«ãªã‚‹

ä»•æ§˜ã§ã™ã€‚

---

ãã®ä»–ã€æŒ™å‹•ãŒé•ã†éƒ¨åˆ†ã¯ä¸‹ã®[æ—©è¦‹è¡¨](#æŒ™å‹•ã®æ—©è¦‹è¡¨)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## å®Ÿè¡Œæ–¹æ³•

```
$ node -v
v10.0.0-pre
$ node --experimental-modules index.mjs
```

ã“ã®ã‚ˆã†ã«ã€ä»Šç¾åœ¨ã¯`--experimental-modules`ã¨ã„ã†ãƒ•ãƒ©ã‚°ãŒå¿…è¦ã§ã™ã€‚

## ãƒ‘ã‚¿ãƒ¼ãƒ³ã¾ã¨ã‚

ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```javascript
// test.mjs
export const a = 1;
export default "dog";
```

### ãƒ«ãƒ¼ãƒˆãŒ CJS

```javascript
// index.js

// === ğŸ™…bad ===

// ESMã®ã‚³ãƒ¼ãƒ‰ã‚’CJSã§å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ãã¾ã›ã‚“
const test = require("./test"); // Must use import to load ES Module

// CJSã«ESMã®Syntaxã¯å­˜åœ¨ã—ã¾ã›ã‚“
import { a } from "./test"; // SyntaxError: Unexpected token {

// ---------------------------------------------------------

// === ğŸ™† good ===

console.log(this); // {}

// dynamic import
// CJSå†…ã§ã‚‚dynamic importã®ä½¿ç”¨ã¯å¯èƒ½ã§ã™
(async () => {
  const test = await import("./test");

  console.log(test); // [Module] { a: 1, default: 'dog' }
})();
```

### ãƒ«ãƒ¼ãƒˆãŒ ESM

```javascript
// index.mjs

// === ğŸ™…bad ===

// ESMã«CJSã®Syntaxã¯å­˜åœ¨ã—ã¾ã›ã‚“
const test = require("./test"); // ReferenceError: require is not defined

// __dirnameã¯å®šç¾©ã•ã‚Œã¦ã„ãªã„ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™
console.log(__dirname);

// fsã¯Nodeã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚ã‚‹ãŸã‚ã€CJSã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™
// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒCJSã®å ´åˆã€named importã¯ä½¿ãˆã¾ã›ã‚“
import { readdirSync } from "fs"; // syntaxError: The requested module 'fs' does not provide an export named 'readdirSync'

// ---------------------------------------------------------

// === ğŸ™† good ===

console.log(this); // undefined

import * as t from "./test";

console.log(import.meta); // { url: 'file:///xxxx/index.mjs' }

// whatwg urlã«æº–æ‹ ã—ã¦ã„ã‚‹ã®ã§ã€urlã¨åŒæ§˜ã®æ›¸ãæ–¹ãŒå¯èƒ½ã§ã™
import * as t from "file:///xxx/test";
console.log(t); // [Module] { a: 1, default: 'dog' }

// =========================
// CJSã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ESMã§å…¥ã‚Œã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™
import fs from "fs";
console.log(typeof fs.readdirSync);

// CJSã¯defaultã«åŒ…ã¾ã‚Œã‚‹
import * as fs from "fs";
console.log(typeof fs.default.readdirSync);

// defaultã‚’fsã«ãƒªãƒãƒ¼ãƒ ã™ã‚‹
import { default as fs } from "fs";
console.log(typeof fs.readdirSync);
// =========================

// dynamic import
(async () => {
  // whatwg urlã§ã®æŒ‡å®šãŒå¯èƒ½ã§ã™
  // ä»Šç¾åœ¨ã€fileä»¥å¤–ã§ã®å–å¾—ã¯ä¸å¯èƒ½ã§ã™
  const baseURL = new URL("file://");
  baseURL.pathname = `${process.cwd()}/test.mjs`;

  const test = await import(baseURL);

  console.log(test); // [Module] { a: 1, default: 'dog' }
})();
```

## æŒ™å‹•ã®æ—©è¦‹è¡¨

CJS ã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å³æ ¼ãƒ¢ãƒ¼ãƒ‰ãŒã¤ã‹ãªã„ã®ã§ã€ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ CJS ã¯å³æ ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãªã„çŠ¶æ…‹ã§ã®æ¯”è¼ƒã§ã™ã€‚

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

| Code          | CJS   | ESM |
| ------------- | ----- | --- |
| `import('x')` | ok    | ok  |
| `import 'x';` | error | ok  |
| `export {};`  | error | ok  |

### ã‚¿ã‚¤ãƒŸãƒ³ã‚°

| Code            | Timing                    | Hoisted | Blocking |
| --------------- | ------------------------- | ------- | -------- |
| `require('x');` | sync                      | no      | yes      |
| `import 'x';`   | untimed (async generally) | yes     | yes      |
| `import('x');`  | async                     | no      | no       |

### ESM ã§ã¯ä½¿ãˆãªã„ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»å¤‰æ•°

ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»å¤‰æ•°ã¯ã€CJS ã§ã®ã¿å­˜åœ¨ã—ã€ESM ã§ã¯å­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

- \_\_dirname
- \_\_filename
- require
- exports
- module
- arguments

### äºˆç´„èªã¸ã®æ“ä½œ

e.g. `var let = 1;`

| Code                          | CJS          | ESM   |
| ----------------------------- | ------------ | ----- |
| `arguments`                   | scope::local | error |
| `arguments = []`              | ok           | error |
| `try {} catch (arguments) {}` | ok           | error |
| `eval`                        | scope::local | error |
| `eval = eval`                 | ok           | error |
| `try {} catch (eval) {}`      | ok           | error |
| `implements`                  | ok           | error |
| `interface`                   | ok           | error |
| `package`                     | ok           | error |
| `private`                     | ok           | error |
| `protected`                   | ok           | error |
| `public`                      | ok           | error |
| `static`                      | ok           | error |
| `await`                       | ok           | error |
| `let`                         | ok           | error |
| `return`                      | error        | error |
| `yield`                       | ok           | error |
| `await`                       | ok           | error |

å³æ ¼ãƒ¢ãƒ¼ãƒ‰æ™‚ã«å¤‰æ•°ã¨ã—ã¦ä½¿ãˆãªããªã‚‹äºˆç´„èªã§ã™ã€‚

- arguments
- eval
- implements
- interface
- package
- private
- protected
- public
- static
- let
- yield

```javascript
// index.js
var arguments;
arguments = [];

var eval = 1;
eval = eval;

// constã¯äºˆç´„èªã§ã™ãŒã€letã¯é•ã„ã¾ã™
var implements, interface, package, private, protected, public,
    static, let, yield, await;
```

### ä¸Šè¨˜ä»¥å¤–ã®è¨±å®¹ã•ã‚Œãªã„è¨˜æ³•

| Code                   | CJS | ESM   | SCRIPT |
| ---------------------- | --- | ----- | ------ |
| `with({}){}`           | ok  | error | ok     |
| `<!--\n`               | ok  | error | ok     |
| `-->\n`                | ok  | error | ok     |
| `0111`                 | ok  | error | ok     |
| `(function (_, _) {})` | ok  | error | ok     |

```javascript
// index.js
// HTMLã‚³ãƒ¡ãƒ³ãƒˆã¯CJSã§ã¯ä½¿ãˆã¾ã™ãŒã€ESMã§ã¯ä½¿ãˆã¾ã›ã‚“
<!--\n
-->\n
```

```
# CJS
$
# ESM
$ Module build failed: SyntaxError: Unexpected token (1:0)
> 1 | <!--\n
    | ^
  2 | -->\n
```

```javascript
// index.js
0111;
```

```
# CJS
$
# ESM
$ SyntaxError: Octal literals are not allowed in strict mode.
```

### è©•ä¾¡ã«é–¢ã™ã‚‹é•ã„

ãƒ‘ãƒ¼ã‚¹ã€å®Ÿè¡Œã¯ã§ãã‚‹ãŒã€è©•ä¾¡çµæœãŒç•°ãªã‚Šã¾ã™ã€‚

| Code                                          | CJS          | ESM       | SCRIPT   |
| --------------------------------------------- | ------------ | --------- | -------- |
| `this`                                        | module(`{}`) | undefined | global   |
| `(function (){return this}())`                | global       | undefined | global   |
| `(function () {return typeof this;}).call(1)` | `object`     | `number`  | `object` |
| `var x`                                       | local        | local     | global   |
| `var x = 0; eval('var x = 1'); x`             | 1            | 0         | 1        |

```javascript
console.log(
  function () {
    return typeof this;
  }.call(1)
);
```

```
# CJS
$ object
# ESM
$ number
```

`call`ã§`this`ã‚’ 1 ã¨ã—ã¦æŸç¸›ã—ã€ã‚¹ã‚³ãƒ¼ãƒ—ã§åŒ…ã‚“ã `function`ã®`this`ã‚’è¿”ã—ãã®å‹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
`this`ã®æŸç¸›ãŒãªã„å ´åˆã¯ã€ã‚¹ã‚³ãƒ¼ãƒ—ã§åŒ…ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€`typeof this === '[Function]'`ã§ã™ã€‚
CJS ã®å ´åˆã¯ã€`[Number: 1]`ã¨ãªã‚Šã€ESM ã®ã¨ãã¯ 1 ã¨ãªã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€ESM ã®ã¨ãã¯`new Number(1)`ã¨ãªã‚‰ãªã„ã®ã§ã€`number`ã¨ãªã‚Šã¾ã™ã€‚

## ã•ã„ã”ã«

ä»Šå¾Œã€Node ç•Œéšˆã§ã¯ã€`.mjs`ã¨ã„ã†æ‹¡å¼µå­ãŒä¸»æµã«ãªã‚‹æœªæ¥ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚(è‡ªåˆ†ã¯ã‚ã¾ã‚Šæœ›ã‚“ã§ã¾ã›ã‚“ã§ã—ãŸãŒã€‚ã€‚ã€‚)
ã“ã®ã¾ã¾é †å½“ã«è¡Œã‘ã°ã€12 ã«ã¯ Stability2(å®‰å®šçš„)ã«è¡Œã‘ã‚‹æ°—ãŒã™ã‚‹ã®ã§ã€æ¥å¹´ãã‚‰ã„ã‹ã‚‰æœ¬ç•ªã‹ãªãƒ¼ã¨æ€ã£ã¦ã„ã¾ã™:D
